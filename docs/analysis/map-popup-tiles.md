# Map Popup Tile Structure (pokeemerald)

## Summary

Map popup graphics in pokeemerald are **tile sheets**, not 9-slice sprites. They contain individual 8×8 pixel tiles that the game assembles to create the popup frame.

## File Structure

### Location
`pokeemerald/graphics/map_popup/`

### Files Per Style
- `{style}.png` - Background bitmap (80×24 pixels)
- `{style}_outline.png` - Outline tile sheet (80×24 pixels = 10×3 tiles)
- `{style}.pal` or `{style}_outline.pal` - Optional JASC-PAL palette (palette can also be embedded in PNG)

### Compiled Assets (Generated by Build)
- `{style}.4bpp` - 4-bit-per-pixel tile data
- `{style}.gbapal` - GBA palette format (16 colors, RGB555)

## Outline Tile Sheet Structure

### Dimensions
- **Total size**: 80×24 pixels
- **Tile count**: 30 tiles (10 wide × 3 tall)
- **Tile size**: 8×8 pixels each

### Tile Layout
The PNG contains 30 tiles read left-to-right, top-to-bottom:

| Tile Range | Purpose | Count |
|------------|---------|-------|
| 0-11       | Top edge decorative tiles | 12 |
| 12         | Top-left corner | 1 |
| 13         | Top-right corner | 1 |
| 14         | Left edge middle | 1 |
| 15         | Right edge middle | 1 |
| 16         | Bottom-left corner | 1 |
| 17         | Bottom-right corner | 1 |
| 18-29      | Bottom edge decorative tiles | 12 |

### How the Game Uses Tiles

From `src/map_name_popup.c`:

```c
#define TILE_TOP_EDGE_START 0x21D
#define TILE_TOP_EDGE_END   0x228    // 12 tiles (0-11)
#define TILE_LEFT_EDGE_TOP  0x229    // Tile 12
#define TILE_RIGHT_EDGE_TOP 0x22A    // Tile 13
#define TILE_LEFT_EDGE_MID  0x22B    // Tile 14
#define TILE_RIGHT_EDGE_MID 0x22C    // Tile 15
#define TILE_LEFT_EDGE_BOT  0x22D    // Tile 16
#define TILE_RIGHT_EDGE_BOT 0x22E    // Tile 17
#define TILE_BOT_EDGE_START 0x22F    // Tiles 18-29
#define TILE_BOT_EDGE_END   0x23A
```

The game:
1. Loads 1024 bytes (128 tiles) of tile data to VRAM starting at tile 0x21D
2. Uses `DrawMapNamePopUpFrame()` to place tiles individually
3. Stretches top/bottom edges by repeating tiles

## Transparency

### In Source PNG
- **Mode**: Indexed color (P)
- **Palette index 0**: Transparent (typically RGB 0,0,0 = black)
- **No transparency metadata**: Must be added during conversion

### For PokeSharp
Convert to RGBA with palette index 0 as transparent:
```python
img = Image.open(png_file)
if img.mode == 'P':
    img.info['transparency'] = 0  # Mark index 0 as transparent
    img = img.convert('RGBA')
```

## Background vs Outline

### Background Files (`{style}.png`)
- Used as a **bitmap** via `BlitBitmapToWindow()`
- Stretched/tiled to fill popup interior
- Also 80×24 pixels

### Outline Files (`{style}_outline.png`)
- Used as **tile data** via `LoadBgTiles()`
- Individual 8×8 tiles placed to form frame
- Not 9-slice sprites!

## Common Mistakes

❌ **Wrong**: Treating outline as 9-slice sprite and making center transparent  
✅ **Right**: Treating outline as tile sheet with palette index 0 transparent

❌ **Wrong**: Auto-detecting and removing "background color"  
✅ **Right**: Converting palette index 0 to RGBA alpha channel

❌ **Wrong**: Assuming PNG uses RGB transparency  
✅ **Right**: Recognizing indexed color mode with GBA palette conventions

## Implementation Notes

The extractor should:
1. Copy background PNGs as-is (with RGBA conversion if needed)
2. Convert outline PNGs from indexed to RGBA with proper transparency
3. **Not** apply 9-slice transparency processing
4. **Not** auto-detect or remove background colors
5. Preserve all 30 tiles in their original layout



